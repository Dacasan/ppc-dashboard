---
import { actions } from 'astro:actions';
import { formatMoney } from '../../lib/format';

interface Props {
  year?: string;
  month?: number;
}

const now = new Date();
const { year = String(now.getFullYear()), month = now.getMonth() + 1 } = Astro.props;

let brands: any[] = [];
let brandDataMap = new Map<string, any>();
let error: string | null = null;

try {
  const { data: brandsData } = await Astro.callAction(actions.getUniqueBrands, undefined);
  brands = brandsData ?? [];

  const { data: records } = await Astro.callAction(actions.getBrandsRanking, { year, month });
  brandDataMap = new Map(
    (records ?? []).map(r => [r.brand || r.nombre_cuenta, r])
  );
} catch (e: any) {
  console.error('[MobileSidebarContent] Error:', e?.message || e);
  error = e?.message || 'Error al cargar menu';
}

const currentPath = Astro.url.pathname;
---

<div class="p-3 flex flex-col gap-2">
  <!-- Dashboard Global link -->
  <a href="/" class:list={[
    "flex items-center gap-3 p-3 rounded-xl border transition-colors",
    currentPath === '/' ? 'bg-zinc-800 border-zinc-700 text-white' : 'bg-white border-zinc-200 text-zinc-700 hover:bg-zinc-50'
  ]}>
    <span class="text-xl">ðŸ“Š</span>
    <span class="font-semibold text-sm">Dashboard General</span>
  </a>

  <div class="h-px bg-zinc-200 my-1"></div>

  <h3 class="text-[11px] font-bold text-zinc-400 uppercase tracking-wider px-1">Marcas ({brands.length})</h3>

  {error ? (
    <div class="text-center py-4">
      <p class="text-xs text-rose-500">Error al cargar marcas</p>
    </div>
  ) : (
    brands.map(brand => {
      const data = brandDataMap.get(brand.name);
      const gasto = data?.cost_total_mes || 0;
      const leads = data?.leads_total_mes || 0;
      const isActive = currentPath.startsWith(`/${brand.slug}`);

      return (
        <div class:list={[
          "p-3 rounded-xl border transition-colors",
          isActive ? 'bg-zinc-800 border-zinc-700 text-white' : 'bg-white border-zinc-200 hover:border-zinc-300 hover:bg-zinc-50'
        ]}>
          <a href={`/${brand.slug}`} class="block mb-2">
            <div class="flex items-center gap-2.5 mb-1.5">
              <span class:list={[
                "w-8 h-8 rounded-lg flex items-center justify-center text-base",
                isActive ? 'bg-zinc-700' : 'bg-zinc-100'
              ]}>ðŸ¦·</span>
              <span class:list={["font-semibold text-sm", isActive ? 'text-white' : 'text-zinc-800']}>{brand.name}</span>
            </div>
            <div class:list={["flex gap-4 text-[11px]", isActive ? 'text-zinc-400' : 'text-zinc-500']}>
              <span>Gasto: <span class:list={["font-semibold", isActive ? 'text-zinc-200' : 'text-zinc-700']}>{formatMoney(gasto)}</span></span>
              <span>Leads: <span class:list={["font-semibold", isActive ? 'text-zinc-200' : 'text-zinc-700']}>{leads}</span></span>
            </div>
          </a>
          <div class="flex rounded-md border border-zinc-200 overflow-hidden text-[10px]">
            <a href={`/${brand.slug}?month=${month}&year=${year}`} class="flex-1 text-center py-0.5 bg-zinc-900 text-white font-medium">Mes</a>
            <a href={`/${brand.slug}/year?year=${year}`} class="flex-1 text-center py-0.5 bg-white text-zinc-500 font-medium hover:bg-zinc-50">AÃ±o</a>
          </div>
        </div>
      );
    })
  )}
</div>
