---
import { getUniqueBrands } from '../../lib/api';
import { getBrandsRanking } from '../../lib/data-service';
import { formatMoney } from '../../lib/format';

interface Props {
  year?: string;
  month?: number;
}

const { year = "2026", month = 1 } = Astro.props;
const brands = await getUniqueBrands();
const records = await getBrandsRanking({ year, month });

const brandDataMap = new Map(
  records.map(r => [r.brand || r.nombre_cuenta, r])
);
---

<!-- Mobile horizontal scroll brands (visible only on smaller screens) -->
<div class="lg:hidden">
  <div class="flex items-center justify-between mb-2">
    <h2 class="font-bold text-sm text-zinc-700">Marcas</h2>
    <span class="text-[11px] text-zinc-400">{brands.length} activas</span>
  </div>

  <div class="flex gap-2.5 overflow-x-auto pb-2 -mx-4 px-4 no-scrollbar snap-x snap-mandatory">
    {brands.map(brand => {
      const data = brandDataMap.get(brand.name);
      const gasto = data?.cost_total_mes || 0;
      const leads = data?.leads_total_mes || 0;

      return (
        <div class="snap-start shrink-0 w-[170px] p-3 rounded-xl border border-zinc-200 bg-white hover:border-zinc-300 hover:shadow-sm transition-all">
          <a href={`/dashboard/${brand.slug}`} class="block mb-2">
            <div class="flex items-center gap-2 mb-2">
              <span class="w-7 h-7 rounded-lg bg-zinc-100 flex items-center justify-center text-sm">ðŸ¦·</span>
              <span class="font-semibold text-xs text-zinc-800 truncate">{brand.name}</span>
            </div>
            <div class="text-[10px] text-zinc-500 space-y-0.5">
              <div>Gasto: <span class="font-semibold text-zinc-700">{formatMoney(gasto)}</span></div>
              <div>Leads: <span class="font-semibold text-zinc-700">{leads}</span></div>
            </div>
          </a>
          <div class="flex rounded-md border border-zinc-200 overflow-hidden text-[10px]">
            <a href={`/dashboard/${brand.slug}`} class="flex-1 text-center py-0.5 bg-zinc-900 text-white font-medium">Mes</a>
            <a href={`/dashboard/${brand.slug}/year`} class="flex-1 text-center py-0.5 bg-white text-zinc-500 font-medium hover:bg-zinc-50">AÃ±o</a>
          </div>
        </div>
      );
    })}
  </div>
</div>
