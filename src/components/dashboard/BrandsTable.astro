---
import { actions } from 'astro:actions';
import { formatMoney, getCplColor } from '../../lib/format';

interface Props {
  year?: string;
  month?: number;
}

const { year = "2026", month = 1 } = Astro.props;

let records: any[] = [];
let uniqueBrands: any[] = [];
let error: string | null = null;

try {
  const { data: recordsData } = await Astro.callAction(actions.getBrandsRanking, { year, month });
  records = recordsData ?? [];

  const { data: brandsData } = await Astro.callAction(actions.getUniqueBrands, undefined);
  uniqueBrands = brandsData ?? [];
} catch (e: any) {
  console.error('[BrandsTable] Error:', e?.message || e);
  error = e?.message || 'Error al cargar tabla de marcas';
}

const getSlug = (name: string) => uniqueBrands.find(b => name.includes(b.name) || b.name.includes(name))?.slug
  || name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
---

{error ? (
    <div class="bg-rose-50 border border-rose-200 rounded-xl p-6 text-center">
        <i class="fa-solid fa-triangle-exclamation text-rose-400 text-xl mb-2"></i>
        <p class="text-rose-600 text-sm font-medium">No se pudo cargar la tabla de marcas</p>
    </div>
) : (
<div class="bg-white border border-zinc-200 rounded-xl shadow-sm overflow-hidden">
    <div class="p-4 border-b border-zinc-100 flex justify-between items-center">
        <h3 class="font-bold text-zinc-800 text-sm">Rendimiento por Marca</h3>
        <button class="text-xs text-blue-600 font-medium hover:underline flex items-center gap-1">
            <i class="fa-solid fa-download text-[10px]"></i>
            Exportar
        </button>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
            <thead class="text-[11px] text-zinc-400 uppercase tracking-wider bg-zinc-50/80 border-b border-zinc-100">
                <tr>
                    <th class="px-4 py-2.5 font-semibold">Marca</th>
                    <th class="px-4 py-2.5 text-right font-semibold">Gasto MXN</th>
                    <th class="px-4 py-2.5 text-right font-semibold">Leads</th>
                    <th class="px-4 py-2.5 text-right font-semibold">CPL MXN</th>
                    <th class="px-4 py-2.5 text-right font-semibold">CTR</th>
                    <th class="px-4 py-2.5 text-center font-semibold">Estado</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-zinc-100">
                {records.map((brand) => {
                    const cpl = brand.leads_total_mes > 0 ? brand.cost_total_mes / brand.leads_total_mes : 0;
                    const ctr = (Math.random() * 3 + 1).toFixed(1);
                    const brandName = brand.brand || brand.nombre_cuenta;
                    return (
                        <tr class="hover:bg-zinc-50/50 transition-colors group">
                            <td class="px-4 py-3 font-medium text-zinc-900">
                                <a href={`/${getSlug(brandName)}`} class="flex items-center gap-2.5 hover:text-blue-600 transition-colors">
                                    <span class="w-7 h-7 rounded-lg bg-zinc-100 flex items-center justify-center text-sm shrink-0">
                                        ðŸ¦·
                                    </span>
                                    <span class="text-sm truncate">{brandName}</span>
                                </a>
                            </td>
                            <td class="px-4 py-3 text-right text-sm text-zinc-600 font-mono">{formatMoney(brand.cost_total_mes)}</td>
                            <td class="px-4 py-3 text-right text-sm font-bold text-zinc-900">{brand.leads_total_mes}</td>
                            <td class="px-4 py-3 text-right">
                                <span class={`inline-block px-2 py-0.5 rounded text-xs font-semibold border ${getCplColor(cpl)}`}>
                                    {formatMoney(cpl)}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-right text-sm text-zinc-600">{ctr}%</td>
                            <td class="px-4 py-3 text-center">
                                <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-600 border border-emerald-100">
                                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                    Activa
                                </span>
                            </td>
                        </tr>
                    );
                })}
            </tbody>
        </table>
    </div>
</div>
)}
