---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import LeadsDataDefer from '../components/dashboard/LeadsDataDefer.astro';
import Skeleton from '../components/ui/Skeleton.astro';

// ==========================================
// PAGINA ESTATICA - Carga instantanea
// La logica pesada vive en LeadsDataDefer (server:defer)
// ==========================================

const user = Astro.locals.user || {};
const userRole = user.role || 'marketing';
const isAdmin = userRole === 'admin';

// 1. LEER PARAMETROS DE URL
const url = Astro.url;
const now = new Date();
const defaultMonth = now.getMonth() + 1;
const defaultYear = String(now.getFullYear());

const monthParam = parseInt(url.searchParams.get('month') || String(defaultMonth));
const yearParam = url.searchParams.get('year') || defaultYear;

const month = isNaN(monthParam) || monthParam < 1 || monthParam > 12 ? defaultMonth : monthParam;
const year = yearParam;

const MONTH_NAMES = [
  '', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];

// Opciones del selector
const AVAILABLE_YEARS = [2026, 2025, 2024, 2023];
const monthYearOptions: { month: number; year: string; label: string }[] = [];
for (const y of AVAILABLE_YEARS) {
  const maxM = y === now.getFullYear() ? now.getMonth() + 1 : 12;
  for (let m = maxM; m >= 1; m--) {
    monthYearOptions.push({ month: m, year: String(y), label: `${MONTH_NAMES[m]} ${y}` });
  }
}
---

<DashboardLayout>
    <div class="p-6 max-w-7xl mx-auto">

        <!-- Header estatico - se renderiza al instante -->
        <section class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-8">
            <div>
                <div class="flex items-center gap-3 flex-wrap">
                    <h1 class="text-2xl md:text-3xl font-black text-zinc-900 tracking-tight">
                        Rendimiento Marketing
                    </h1>
                    <span class="text-zinc-300 font-light text-2xl md:text-3xl">&mdash;</span>

                    <div class="relative">
                        <select id="month-year-selector" class="appearance-none text-xl md:text-2xl font-black text-blue-600 bg-transparent border-none cursor-pointer pr-8 focus:outline-none hover:text-blue-700 transition-colors">
                            {monthYearOptions.map(opt => (
                                <option value={`${opt.month}-${opt.year}`} selected={opt.month === month && opt.year === year}>
                                    {opt.label}
                                </option>
                            ))}
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-1 top-1/2 -translate-y-1/2 text-blue-500 text-sm pointer-events-none"></i>
                    </div>
                </div>
                <p class="text-zinc-400 text-xs mt-1 font-medium">Flujo de prospectos por bloques semanales de cada unidad de negocio.</p>
            </div>

            <div class={`flex items-center gap-2 px-3 py-1.5 rounded-lg border text-sm font-medium shadow-sm transition-colors ${isAdmin ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-emerald-50 text-emerald-700 border-emerald-100'}`}>
                <i class={`fa-solid ${isAdmin ? 'fa-unlock-keyhole' : 'fa-shield-halved'}`}></i>
                Vista: {isAdmin ? 'Direccion (Gasto Visible)' : 'Marketing (Gasto Oculto)'}
            </div>
        </section>

        <!-- Server Island: los datos se cargan de forma asincrona -->
        <LeadsDataDefer server:defer month={month} year={year}>
            <!-- Fallback: esqueleto de carga visible al instante -->
            <div slot="fallback" class="flex flex-col gap-6">
                {[1, 2, 3].map(() => (
                    <div class="bg-white rounded-2xl border border-zinc-200 shadow-sm overflow-hidden">
                        <!-- Header skeleton -->
                        <div class="bg-zinc-50 border-b border-zinc-200 px-6 py-4 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
                            <div class="flex items-center gap-3">
                                <Skeleton class="w-10 h-10 rounded-lg" />
                                <Skeleton class="h-5 w-32" />
                            </div>
                            <div class="flex items-center gap-4 bg-white px-4 py-2 rounded-lg border border-zinc-200">
                                <Skeleton class="h-8 w-24" />
                                {isAdmin && <Skeleton class="h-8 w-28" />}
                            </div>
                        </div>
                        <!-- Period blocks skeleton -->
                        <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 divide-y md:divide-y-0 md:divide-x divide-zinc-100">
                            {[1, 2, 3, 4, 5, 6].map(() => (
                                <div class="p-5 flex flex-col items-center justify-center text-center">
                                    <Skeleton class="h-3 w-16 mb-3" />
                                    <Skeleton class="h-8 w-12 mb-3" />
                                    <Skeleton class="h-7 w-full rounded-lg" />
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
            </div>
        </LeadsDataDefer>

    </div>
</DashboardLayout>

<script>
    function init() {
        const sel = document.getElementById('month-year-selector') as HTMLSelectElement | null;
        if (!sel) return;
        sel.addEventListener('change', () => {
            const [m, y] = sel.value.split('-');
            const url = new URL(window.location.href);
            url.searchParams.set('month', m);
            url.searchParams.set('year', y);
            window.location.href = url.toString();
        });
    }
    init();
    document.addEventListener('astro:after-swap', init);
</script>
