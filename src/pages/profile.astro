---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import BrandsSidebar from '../components/dashboard/BrandsSidebar.astro';
import MobileSidebarContent from '../components/dashboard/MobileSidebarContent.astro';
import Skeleton from '../components/ui/Skeleton.astro';

const user = Astro.locals.user;
if (!user) return Astro.redirect('/login');

const successParam = Astro.url.searchParams.get('success');
const errorParam = Astro.url.searchParams.get('error');

const successMessages: Record<string, string> = {
  password_changed: 'Contraseña actualizada correctamente.',
  recovery_sent: 'Se envió un correo de recuperación a tu email.',
};
const errorMessages: Record<string, string> = {
  password_mismatch: 'Las contraseñas no coinciden.',
  password_failed: 'No se pudo cambiar la contraseña. Verifica tu contraseña actual.',
  recovery_failed: 'No se pudo enviar el correo de recuperación.',
  short_password: 'La contraseña debe tener al menos 8 caracteres.',
};

const successMsg = successParam ? (successMessages[successParam] ?? null) : null;
const errorMsg = errorParam ? (errorMessages[errorParam] ?? 'Error desconocido.') : null;

const initials = user.name
  ? user.name.split(' ').map((n: string) => n[0]).join('').slice(0, 2).toUpperCase()
  : 'U';
---

<DashboardLayout title="Mi Perfil | A1 Marketing">

    <!-- Left sidebar -->
    <BrandsSidebar slot="left-sidebar" server:defer>
        <aside slot="fallback" class="hidden lg:block w-[280px] shrink-0 bg-white border-r border-zinc-200">
            <div class="p-4"><Skeleton class="h-6 w-20 mb-4" /><Skeleton class="h-20 w-full mb-2" /><Skeleton class="h-20 w-full" /></div>
        </aside>
    </BrandsSidebar>

    <!-- Mobile sidebar -->
    <MobileSidebarContent slot="mobile-sidebar" server:defer>
        <div slot="fallback" class="p-4"><Skeleton class="h-12 w-full mb-2" /><Skeleton class="h-12 w-full" /></div>
    </MobileSidebarContent>

    <!-- Center content -->
    <div class="flex flex-col gap-6 max-w-lg">

        <!-- Header -->
        <header class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-white text-xl font-bold shadow-lg">
                {initials}
            </div>
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-zinc-900">{user.name}</h1>
                <p class="text-sm text-zinc-500">{user.email}</p>
            </div>
        </header>

        <!-- Success message -->
        {successMsg && (
            <div class="flex items-start gap-2.5 px-4 py-3 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-700">
                <i class="fa-solid fa-circle-check mt-0.5 shrink-0"></i>
                <span>{successMsg}</span>
            </div>
        )}

        <!-- Error message -->
        {errorMsg && (
            <div class="flex items-start gap-2.5 px-4 py-3 bg-amber-50 border border-amber-200 rounded-xl text-sm text-amber-700">
                <i class="fa-solid fa-triangle-exclamation mt-0.5 shrink-0"></i>
                <span>{errorMsg}</span>
            </div>
        )}

        <!-- User info card -->
        <div class="bg-white border border-zinc-200 rounded-xl shadow-sm overflow-hidden">
            <div class="px-5 py-4 border-b border-zinc-100 bg-zinc-50">
                <h3 class="font-bold text-sm text-zinc-700">Información de la cuenta</h3>
            </div>
            <div class="p-5 space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-xs text-zinc-400 uppercase tracking-wider font-semibold">Nombre</span>
                        <p class="text-sm font-medium text-zinc-900">{user.name || '—'}</p>
                    </div>
                </div>
                <div class="h-px bg-zinc-100"></div>
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-xs text-zinc-400 uppercase tracking-wider font-semibold">Email</span>
                        <p class="text-sm font-medium text-zinc-900">{user.email}</p>
                    </div>
                </div>
                <div class="h-px bg-zinc-100"></div>
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-xs text-zinc-400 uppercase tracking-wider font-semibold">ID de usuario</span>
                        <p class="text-sm font-mono text-zinc-500">{user.id}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change password -->
        <div class="bg-white border border-zinc-200 rounded-xl shadow-sm overflow-hidden">
            <div class="px-5 py-4 border-b border-zinc-100 bg-zinc-50">
                <h3 class="font-bold text-sm text-zinc-700">Cambiar contraseña</h3>
            </div>
            <form method="POST" action="/api/change-password" class="p-5 space-y-4">
                <div class="flex flex-col gap-1">
                    <label for="current_password" class="text-xs font-semibold text-zinc-600">Contraseña actual</label>
                    <input
                        id="current_password"
                        type="password"
                        name="current_password"
                        required
                        autocomplete="current-password"
                        class="w-full px-3.5 py-2.5 rounded-lg border border-zinc-200 text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                    />
                </div>
                <div class="flex flex-col gap-1">
                    <label for="new_password" class="text-xs font-semibold text-zinc-600">Nueva contraseña</label>
                    <input
                        id="new_password"
                        type="password"
                        name="new_password"
                        required
                        minlength="8"
                        autocomplete="new-password"
                        class="w-full px-3.5 py-2.5 rounded-lg border border-zinc-200 text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                    />
                </div>
                <div class="flex flex-col gap-1">
                    <label for="confirm_password" class="text-xs font-semibold text-zinc-600">Confirmar nueva contraseña</label>
                    <input
                        id="confirm_password"
                        type="password"
                        name="confirm_password"
                        required
                        minlength="8"
                        autocomplete="new-password"
                        class="w-full px-3.5 py-2.5 rounded-lg border border-zinc-200 text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                    />
                </div>
                <button
                    type="submit"
                    class="w-full px-4 py-2.5 bg-zinc-900 hover:bg-zinc-800 text-white text-sm font-semibold rounded-lg transition"
                >
                    Actualizar contraseña
                </button>
            </form>
        </div>

        <!-- Recovery email -->
        <div class="bg-white border border-zinc-200 rounded-xl shadow-sm overflow-hidden">
            <div class="px-5 py-4 border-b border-zinc-100 bg-zinc-50">
                <h3 class="font-bold text-sm text-zinc-700">Recuperar contraseña</h3>
            </div>
            <div class="p-5">
                <p class="text-sm text-zinc-500 mb-4">
                    Envia un correo de recuperación a <strong class="text-zinc-700">{user.email}</strong> para restablecer tu contraseña.
                </p>
                <form method="POST" action="/api/request-recovery">
                    <input type="hidden" name="email" value={user.email} />
                    <button
                        type="submit"
                        class="w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition"
                    >
                        Enviar correo de recuperación
                    </button>
                </form>
            </div>
        </div>

        <!-- Logout -->
        <div class="bg-white border border-zinc-200 rounded-xl shadow-sm overflow-hidden">
            <div class="p-5 flex items-center justify-between">
                <div>
                    <h3 class="font-bold text-sm text-zinc-700">Cerrar sesión</h3>
                    <p class="text-xs text-zinc-400 mt-1">Cierra tu sesión en este dispositivo.</p>
                </div>
                <a
                    href="/auth/logout"
                    class="px-4 py-2 bg-zinc-100 hover:bg-zinc-200 text-zinc-700 text-sm font-medium rounded-lg transition"
                >
                    Cerrar sesión
                </a>
            </div>
        </div>

        <a href="/" class="text-sm text-blue-600 font-medium hover:underline flex items-center gap-2">
            <i class="fa-solid fa-arrow-left text-xs"></i> Volver al dashboard
        </a>
    </div>
</DashboardLayout>
