---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import BrandsSidebar from '../../components/dashboard/BrandsSidebar.astro';
import MobileSidebarContent from '../../components/dashboard/MobileSidebarContent.astro';
import BrandMonthView from '../../components/dashboard/BrandMonthView.astro';
import CampaignsTable from '../../components/dashboard/CampaignsTable.astro';
import Skeleton from '../../components/ui/Skeleton.astro';
import { getUniqueBrands } from '../../lib/api';
import { getBrandFullData } from '../../lib/data-service';

export const prerender = false;
const { brand } = Astro.params;

const brands = await getUniqueBrands();
const currentBrand = brands.find(b => b.slug === brand);
if (!currentBrand) return Astro.redirect('/');

const { brandReport, campaigns } = await getBrandFullData(currentBrand.name, { year: "2026", month: 1 });
---

<DashboardLayout title={`Dashboard | ${currentBrand.name}`}>

    <!-- Left sidebar -->
    <BrandsSidebar slot="left-sidebar" server:defer>
        <aside slot="fallback" class="hidden lg:block w-[280px] shrink-0 bg-white border-r border-zinc-200">
            <div class="p-4"><Skeleton class="h-6 w-20 mb-4" /><Skeleton class="h-20 w-full mb-2" /><Skeleton class="h-20 w-full" /></div>
        </aside>
    </BrandsSidebar>

    <!-- Mobile sidebar content -->
    <MobileSidebarContent slot="mobile-sidebar" server:defer>
        <div slot="fallback" class="p-4"><Skeleton class="h-12 w-full mb-2" /><Skeleton class="h-12 w-full" /></div>
    </MobileSidebarContent>

    <!-- Center content -->
    <div class="flex flex-col gap-6">
        <header class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white border border-zinc-200 rounded-xl flex items-center justify-center text-2xl shadow-sm">
                    {currentBrand.emoji}
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-zinc-900 leading-none">{currentBrand.name}</h1>
                    <p class="text-xs text-zinc-400 mt-1">Enero 2026</p>
                </div>
            </div>
            <a href="/" class="inline-flex items-center gap-2 text-xs font-medium px-3 py-2 bg-white border border-zinc-200 rounded-lg hover:bg-zinc-50 transition">
                <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">Volver</span>
            </a>
        </header>

        {brandReport ? <BrandMonthView report={brandReport} /> :
            <div class="p-4 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded-lg text-sm">Sin datos de Marca.</div>
        }

        {campaigns.length > 0 && <CampaignsTable campaigns={campaigns} />}
    </div>
</DashboardLayout>
