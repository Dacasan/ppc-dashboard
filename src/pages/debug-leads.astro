---
// src/pages/debug-leads.astro
import { pb } from '../lib/pb';

// --- DIAGNOSTICOS ---
const diagnostics: Record<string, string> = {};
const pageLoadStart = Date.now();

// 1. Verificar token
const token = import.meta.env.POCKETBASE_TOKEN || (typeof process !== 'undefined' ? process.env.POCKETBASE_TOKEN : undefined);
diagnostics['POCKETBASE_TOKEN'] = token ? `Configurado (${token.substring(0, 15)}...)` : 'NO ENCONTRADO';
diagnostics['authStore.isValid'] = String(pb.authStore.isValid);
diagnostics['PocketBase URL'] = 'https://a1-pocketbase.adwebcrm.com';

let pbHealthy = false;
try {
    const health = await pb.health.check();
    pbHealthy = true;
    diagnostics['PB Health'] = `OK - code: ${health.code}`;
} catch (e) {
    diagnostics['PB Health'] = `ERROR: ${String(e)}`;
}

// 2. Traer Leads
let allLeads: any[] = [];
let queryError = '';
let dbQueryStart = 0;
let dbQueryEnd = 0;

try {
    pb.autoCancellation(false);
    dbQueryStart = Date.now();
    
    // Traemos 2000 leads para tener un buen historial de varios meses
    const records = await pb.collection('leads_report').getList(1, 2000, {
        sort: '-created'
    });
    
    allLeads = records.items;
    
    // SISTEMA ANTI-MESES CORTADOS:
    // Si trajimos 2000 registros exactos, significa que el último mes está incompleto.
    // Vamos a identificar cuál es ese mes viejo y lo eliminamos de la data para que los demás salgan perfectos.
    if (allLeads.length === 2000) {
        const oldestLead = allLeads[allLeads.length - 1];
        const mesCortado = oldestLead.Mes_Ano; // Ej: "January 2025"
        if (mesCortado) {
            allLeads = allLeads.filter(lead => lead.Mes_Ano !== mesCortado);
            diagnostics['Filtro Anti-Cortes'] = `Mes incompleto ignorado: ${mesCortado}`;
        }
    }
    
    dbQueryEnd = Date.now();
    diagnostics['Query Leads (Procesados)'] = `OK - ${allLeads.length} registros válidos en ${dbQueryEnd - dbQueryStart}ms`;
} catch (e: any) {
    queryError = String(e);
    diagnostics['Query Leads'] = `ERROR: ${queryError}`;
}

// 3. Procesar estadísticas (Agrupación simple, sin duplicados)
const resumen: Record<string, any> = {};

allLeads.forEach(lead => {
    const dominio = lead.Dominio || 'Desconocido';
    const semana = lead.Semana || 'Sin semana';
    
    // Llave única para juntar Dominio y Semana
    const key = `${dominio}|${semana}`;

    if (!resumen[key]) {
        resumen[key] = {
            dominio: dominio,
            semana: semana,
            brand: lead.brand || '',
            totalLeads: 0
        };
    }

    // Como Airtable ya los filtró, todos valen 1 y son reales.
    resumen[key].totalLeads++;
});

// Parsear la semana para extraer fecha y ordenar por mas reciente
// Formato esperado: "1-5 Feb 2026", "6-10 Jan 2026", etc.
const MONTH_MAP: Record<string, number> = {
    'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6,
    'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12
};

function parseSemanaToSortKey(semana: string): number {
    if (!semana || semana === 'Sin semana') return 0;
    // Extraer partes: "16-20 Feb 2026" -> dayEnd=20, month=2, year=2026
    const match = semana.match(/(\d+)-(\d+)\s+(\w+)\s+(\d{4})/);
    if (!match) return 0;
    const [, , dayEnd, monthStr, yearStr] = match;
    const monthNum = MONTH_MAP[monthStr] || 0;
    // Clave numerica: YYYYMMDD (usando el dia final del rango para ordenar)
    return parseInt(yearStr) * 10000 + monthNum * 100 + parseInt(dayEnd);
}

// Convertir a lista y ordenar por fecha descendente (mas reciente primero)
// Dentro del mismo periodo, ordenar por dominio A-Z
const groupedLeads = Object.values(resumen).sort((a: any, b: any) => {
    const dateA = parseSemanaToSortKey(a.semana);
    const dateB = parseSemanaToSortKey(b.semana);
    if (dateB !== dateA) return dateB - dateA; // Fecha descendente
    return a.dominio.localeCompare(b.dominio);  // Mismo periodo: alfabetico por dominio
});

const pageLoadEnd = Date.now();
---

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DEBUG LEADS - PPC Dashboard</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: monospace; padding: 20px; background: #111; color: #eee; max-width: 1600px; margin: 0 auto; }
        h1 { color: #0f0; border-bottom: 2px solid #0f0; padding-bottom: 10px; font-size: 20px; }
        h2 { margin-top: 40px; background: #222; color: #0f0; padding: 10px; border-left: 4px solid #0f0; font-size: 14px; }
        h3 { color: #0f0; margin-top: 25px; font-size: 13px; border-bottom: 1px solid #333; padding-bottom: 6px; }
        p { font-size: 13px; line-height: 1.5; }

        .diag-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .diag-table td { border: 1px solid #333; padding: 8px 12px; font-size: 12px; }
        .diag-table td:first-child { font-weight: bold; color: #888; width: 220px; }
        .ok { color: #0f0; }
        .fail { color: #f44; font-weight: bold; }
        .warn { color: #ff0; }

        table.data { width: 100%; border-collapse: collapse; background: #1a1a1a; font-size: 12px; margin-bottom: 20px; }
        table.data th, table.data td { border: 1px solid #333; padding: 6px; text-align: right; }
        table.data th { background: #222; text-align: center; font-weight: bold; color: #0f0; }
        table.data td.text { text-align: left; color: #ccc; }
        .val { font-weight: bold; color: #fff; }

        .debug-json { background: #0a0a0a; color: #0f0; padding: 15px; overflow-x: auto; max-height: 400px; border: 1px solid #333; font-size: 11px; margin-bottom: 20px; }
        .alert { background: #441111; border: 1px solid #f44; color: #faa; padding: 15px; margin: 20px 0; border-radius: 4px; font-size: 13px; }

        /* Section nav */
        .section-nav { background: #1a1a1a; border: 1px solid #333; padding: 12px; margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 8px; }
        .section-nav a { color: #0f0; text-decoration: none; font-size: 11px; padding: 4px 10px; border: 1px solid #333; background: #222; transition: all 0.2s; }
        .section-nav a:hover { background: #0f0; color: #111; }

        /* Tabs para JSON */
        .tab-container { margin-bottom: 20px; }
        .tab-buttons { display: flex; gap: 0; margin-bottom: 0; }
        .tab-btn { background: #1a1a1a; color: #666; border: 1px solid #333; border-bottom: none; padding: 8px 16px; cursor: pointer; font-family: monospace; font-size: 12px; transition: all 0.2s; }
        .tab-btn:hover { color: #0f0; background: #222; }
        .tab-btn.active { color: #0f0; background: #0a0a0a; border-color: #0f0; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

    <h1>DEBUG LEADS: X-Ray de Contactos de n8n</h1>
    <p>Diagnosticos de la coleccion <code>leads_report</code> - {new Date().toISOString()}</p>
    <p style="color: #666;">Page render: {pageLoadEnd - pageLoadStart}ms</p>

    <div class="section-nav">
        <a href="#s1">[1] Sistema</a>
        <a href="#s2">[2] Agrupación y Sumas</a>
        <a href="#s3">[3] JSON Samples</a>
    </div>

    <h2 id="s1">1. Diagnosticos del Sistema</h2>
    <table class="diag-table">
        {Object.entries(diagnostics).map(([key, value]) => (
            <tr>
                <td>{key}</td>
                <td class={value.includes('ERROR') || value.includes('NO ENCONTRADO') || value === 'false' ? 'fail' : 'ok'}>
                    {value}
                </td>
            </tr>
        ))}
    </table>

    {queryError && (
        <div class="alert">
            <strong>ERROR DE DB:</strong> {queryError}
        </div>
    )}

    <h2 id="s2">2. Leads Agrupados (Dominio + Semana) &mdash; Ordenados por fecha mas reciente</h2>
    <p style="color: #888;">Ordenado de mas reciente a mas viejo. Dentro del mismo periodo, por dominio A-Z.</p>

    {groupedLeads.length === 0 ? (
        <p class="fail">No se encontraron leads.</p>
    ) : (
        <table class="data">
            <thead>
                <tr>
                    <th style="width: 180px;">Semana (Periodo)</th>
                    <th>Dominio</th>
                    <th>Marca (Brand)</th>
                    <th>Total Leads Únicos</th>
                </tr>
            </thead>
            <tbody>
                {groupedLeads.map((r, i) => {
                    const prevSemana = i > 0 ? groupedLeads[i - 1].semana : null;
                    const isNewPeriod = r.semana !== prevSemana;
                    return (
                        <tr style={isNewPeriod && i > 0 ? 'border-top: 2px solid #0f0;' : ''}>
                            <td class="text" style={`color: #0ff; font-weight: bold; ${!isNewPeriod ? 'color: #333;' : ''}`}>
                                {isNewPeriod ? r.semana : ''}
                            </td>
                            <td class="text"><strong>{r.dominio}</strong></td>
                            <td class="text">{r.brand}</td>
                            <td class="val">{r.totalLeads}</td>
                        </tr>
                    );
                })}
            </tbody>
        </table>
    )}

    <h2 id="s3">3. RAW JSON SAMPLES</h2>
    <p style="color: #888;">Auditoría de campos exactos que están llegando desde n8n a PocketBase.</p>

    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="tab-list">LISTA RAW (Muestra de 1 Lead)</button>
            <button class="tab-btn" data-tab="tab-group">ARRAY DE AGRUPACIÓN (Dashboard)</button>
        </div>

        <div id="tab-list" class="tab-content active">
            <div class="debug-json">
                <pre>{JSON.stringify(allLeads.length > 0 ? allLeads[0] : "No hay leads", null, 4)}</pre>
            </div>
            {allLeads.length > 0 && <p style="color: #666; margin-top: 8px;">Mostrando 1 de los {allLeads.length} leads obtenidos en la consulta.</p>}
        </div>

        <div id="tab-group" class="tab-content">
            <div class="debug-json">
                <pre>{JSON.stringify(groupedLeads, null, 4)}</pre>
            </div>
            <p style="color: #666; margin-top: 8px;">Así es como el servidor de Astro procesa la tabla final antes de dibujarla.</p>
        </div>
    </div>

    <p style="color: #333; margin-top: 40px; text-align: center;">--- END DEBUG LEADS MODE ---</p>

    <script>
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                if (!tabId) return;

                btn.closest('.tab-container')?.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.closest('.tab-container')?.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(tabId)?.classList.add('active');
            });
        });
    </script>
</body>
</html>
