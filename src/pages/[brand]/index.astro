---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import BrandsSidebar from '../../components/dashboard/BrandsSidebar.astro';
import MobileSidebarContent from '../../components/dashboard/MobileSidebarContent.astro';
import BrandMonthView from '../../components/dashboard/BrandMonthView.astro';
import CampaignsTable from '../../components/dashboard/CampaignsTable.astro';
import Skeleton from '../../components/ui/Skeleton.astro';
import { getUniqueBrands } from '../../lib/api';
import { getBrandFullData } from '../../lib/data-service';

export const prerender = false;
const { brand } = Astro.params;

const brands = await getUniqueBrands();
const currentBrand = brands.find(b => b.slug === brand);
if (!currentBrand) return Astro.redirect('/');

// Read month/year from URL params, default to January 2026
const url = Astro.url;
const monthParam = parseInt(url.searchParams.get('month') || '1');
const year = url.searchParams.get('year') || '2026';
const month = isNaN(monthParam) || monthParam < 1 || monthParam > 12 ? 1 : monthParam;

const MONTH_NAMES = [
  '', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];

const { brandReport, campaigns } = await getBrandFullData(currentBrand.name, { year, month });
---

<DashboardLayout title={`Dashboard | ${currentBrand.name}`}>

    <!-- Left sidebar -->
    <BrandsSidebar slot="left-sidebar" year={year} month={month} server:defer>
        <aside slot="fallback" class="hidden lg:block w-[280px] shrink-0 bg-white border-r border-zinc-200">
            <div class="p-4"><Skeleton class="h-6 w-20 mb-4" /><Skeleton class="h-20 w-full mb-2" /><Skeleton class="h-20 w-full" /></div>
        </aside>
    </BrandsSidebar>

    <!-- Mobile sidebar content -->
    <MobileSidebarContent slot="mobile-sidebar" server:defer>
        <div slot="fallback" class="p-4"><Skeleton class="h-12 w-full mb-2" /><Skeleton class="h-12 w-full" /></div>
    </MobileSidebarContent>

    <!-- Center content -->
    <div class="flex flex-col gap-6">
        <header class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white border border-zinc-200 rounded-xl flex items-center justify-center text-2xl shadow-sm">
                    ðŸ¦·
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-zinc-900 leading-none">{currentBrand.name}</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <!-- Month dropdown for brand view -->
                        <div class="relative">
                            <select
                                id="brand-month-selector"
                                class="appearance-none text-xs text-zinc-500 bg-transparent border-none cursor-pointer pr-5 focus:outline-none hover:text-zinc-700 transition-colors"
                            >
                                {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => (
                                    <option value={m} selected={m === month}>{MONTH_NAMES[m]}</option>
                                ))}
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-0 top-1/2 -translate-y-1/2 text-zinc-400 text-[9px] pointer-events-none"></i>
                        </div>
                        <span class="text-xs text-zinc-400">{year}</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- View toggle: Mes / AÃ±o -->
                <div class="flex rounded-md border border-zinc-200 overflow-hidden text-xs">
                    <span class="px-3 py-1.5 bg-zinc-900 text-white font-medium">Mes</span>
                    <a href={`/${currentBrand.slug}/year?year=${year}`} class="px-3 py-1.5 bg-white text-zinc-500 font-medium hover:bg-zinc-50 transition">AÃ±o</a>
                </div>
                <a href="/" class="inline-flex items-center gap-2 text-xs font-medium px-3 py-2 bg-white border border-zinc-200 rounded-lg hover:bg-zinc-50 transition">
                    <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">Volver</span>
                </a>
            </div>
        </header>

        {brandReport ? <BrandMonthView report={brandReport} /> :
            <div class="p-4 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded-lg text-sm">Sin datos de Marca para {MONTH_NAMES[month]} {year}.</div>
        }

        {campaigns.length > 0 && <CampaignsTable campaigns={campaigns} />}
    </div>
</DashboardLayout>

<script>
    function initBrandMonthSelector() {
        const sel = document.getElementById('brand-month-selector') as HTMLSelectElement | null;
        if (!sel) return;
        sel.addEventListener('change', () => {
            const url = new URL(window.location.href);
            url.searchParams.set('month', sel.value);
            window.location.href = url.toString();
        });
    }

    initBrandMonthSelector();
    document.addEventListener('astro:after-swap', initBrandMonthSelector);
</script>
