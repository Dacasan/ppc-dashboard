---
import { pb } from '../lib/pb';

// CONFIGURACI√ìN DE PRUEBA
const TARGET_YEAR = "2026";
// Nota: Puedes cambiar esto a 1 (Enero) o 2 (Febrero) seg√∫n los datos que tengas
const TARGET_MONTH = 2; 

// 1. TRAER REGISTROS TIPO "MARCA" (Totales consolidados)
const marcas = await pb.collection('campaign_reports').getFullList({
    filter: `year = "${TARGET_YEAR}" && month_num = ${TARGET_MONTH} && tipo_registro = "Marca"`,
    sort: '-created'
});

// 2. TRAER REGISTROS TIPO "CAMPA√ëA" (Desglose individual)
const campa√±as = await pb.collection('campaign_reports').getFullList({
    filter: `year = "${TARGET_YEAR}" && month_num = ${TARGET_MONTH} && tipo_registro = "Campa√±a"`,
    sort: 'brand, -cost_total_mes'
});

const formatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
---

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DEBUG DATA - A1 Marketing</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f0f0f0; }
        h1 { color: #333; border-bottom: 2px solid #333; }
        h2 { margin-top: 40px; background: #333; color: #fff; padding: 10px; }
        
        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: right; }
        th { background: #eee; text-align: center; font-weight: bold; position: sticky; top: 0; }
        td.text { text-align: left; }
        
        .zero { color: #ccc; }
        .val { font-weight: bold; color: #000; }
        
        .debug-json { background: #222; color: #0f0; padding: 15px; overflow-x: auto; max-height: 300px; }
    </style>
</head>
<body>

    <h1>üõ†Ô∏è DEBUG MODE: Mes {TARGET_MONTH} / {TARGET_YEAR}</h1>
    <p>Verificando estructura de datos para la vista mensual (Periodos de 5 d√≠as).</p>

    <h2>1. Registros Consolidados (tipo_registro = "Marca")</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Marca</th>
                <th>Tipo</th>
                <th>Gasto Total</th>
                <th>Leads Total</th>
                <th>Cost 1-5</th>
                <th>Cost 6-10</th>
                <th>Cost 11-15</th>
                <th>Cost 16-20</th>
                <th>Cost 21-25</th>
                <th>Cost 26-31</th>
            </tr>
        </thead>
        <tbody>
            {marcas.map(r => (
                <tr>
                    <td class="text">{r.id}</td>
                    <td class="text"><strong>{r.brand}</strong></td>
                    <td class="text">{r.tipo_registro}</td>
                    <td class="val">{formatter.format(r.cost_total_mes)}</td>
                    <td class="val">{r.leads_total_mes}</td>
                    <td class={r.cost_01_05 ? 'val' : 'zero'}>{r.cost_01_05}</td>
                    <td class={r.cost_06_10 ? 'val' : 'zero'}>{r.cost_06_10}</td>
                    <td class={r.cost_11_15 ? 'val' : 'zero'}>{r.cost_11_15}</td>
                    <td class={r.cost_16_20 ? 'val' : 'zero'}>{r.cost_16_20}</td>
                    <td class={r.cost_21_25 ? 'val' : 'zero'}>{r.cost_21_25}</td>
                    <td class={r.cost_26_31 ? 'val' : 'zero'}>{r.cost_26_31}</td>
                </tr>
            ))}
        </tbody>
    </table>

    <h2>2. Registros Individuales (tipo_registro = "Campa√±a")</h2>
    <table>
        <thead>
            <tr>
                <th>Marca</th>
                <th>Nombre Campa√±a</th>
                <th>Gasto Total</th>
                <th>Leads</th>
                <th>C. 1-5</th>
                <th>C. 6-10</th>
                <th>C. 11-15</th>
                <th>C. 16-20</th>
                <th>C. 21-25</th>
                <th>C. 26-31</th>
            </tr>
        </thead>
        <tbody>
            {campa√±as.map(r => (
                <tr>
                    <td class="text">{r.brand}</td>
                    <td class="text" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {r.campaign_name}
                    </td>
                    <td class="val">{formatter.format(r.cost_total_mes)}</td>
                    <td>{r.leads_total_mes}</td>
                    
                    <td class={r.cost_01_05 ? '' : 'zero'}>{Math.round(r.cost_01_05)}</td>
                    <td class={r.cost_06_10 ? '' : 'zero'}>{Math.round(r.cost_06_10)}</td>
                    <td class={r.cost_11_15 ? '' : 'zero'}>{Math.round(r.cost_11_15)}</td>
                    <td class={r.cost_16_20 ? '' : 'zero'}>{Math.round(r.cost_16_20)}</td>
                    <td class={r.cost_21_25 ? '' : 'zero'}>{Math.round(r.cost_21_25)}</td>
                    <td class={r.cost_26_31 ? '' : 'zero'}>{Math.round(r.cost_26_31)}</td>
                </tr>
            ))}
        </tbody>
    </table>

    <h2>3. RAW JSON (Un ejemplo de Marca)</h2>
    <div class="debug-json">
        <pre>{JSON.stringify(marcas[0] || "No se encontraron marcas", null, 4)}</pre>
    </div>

</body>
</html>
